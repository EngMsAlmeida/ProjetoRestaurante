@page "/gerenciar-produtos"
@using ProjetoRestaurante.Data
@using ProjetoRestaurante.Models
@inject AppDbContext DbContext
@using Microsoft.EntityFrameworkCore

<div class="container mt-4">
    <div class="card shadow-sm p-4">
        <h2 class="text-primary">
            <i class="bi @(isEditando ? "bi-pencil-square" : "bi-plus-circle")"></i> 
            @(isEditando ? "Editando Produto" : "Novo Item no Card√°pio")
        </h2>
        <hr />
        
        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label font-weight-bold">Nome do Lanche/Bebida</label>
                <input type="text" class="form-control form-control-lg" @bind="novoProduto.Nome" placeholder="Ex: X-Burguer Artesanal" />
            </div>
            <div class="col-md-3">
                <label class="form-label font-weight-bold">Pre√ßo (R$)</label>
                <input type="number" step="0.01" class="form-control form-control-lg" @bind="novoProduto.Preco" />
            </div>
            <div class="col-md-3">
                <label class="form-label font-weight-bold">Categoria</label>
                <select class="form-select form-select-lg" @bind="novoProduto.Categoria">
                    <option value="">Selecione...</option>
                    <option value="Lanche">üçî Lanche</option>
                    <option value="Bebida">ü•§ Bebida</option>
                    <option value="Sobremesa">üç∞ Sobremesa</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button class="btn @(isEditando ? "btn-primary" : "btn-success") btn-lg w-100" @onclick="Salvar">
                    <i class="bi bi-save"></i> @(isEditando ? "Atualizar Altera√ß√µes" : "Gravar no Banco")
                </button>
            </div>
        </div>
    </div>

    @if (produtosCadastrados != null && produtosCadastrados.Any())
    {
        <div class="mt-5">
            <h4>üìã Itens Cadastrados</h4>
            <table class="table table-hover table-striped mt-3">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Nome</th>
                        <th>Pre√ßo</th>
                        <th>Categoria</th>
                        <th class="text-center">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var p in produtosCadastrados)
                    {
                        <tr>
                            <td>@p.Id</td>
                            <td>@p.Nome</td>
                            <td>@p.Preco.ToString("C")</td>
                            <td>
                                @if (p.Categoria == "Lanche") {
                                    <span class="badge bg-success">üçî @p.Categoria</span>
                                } else if (p.Categoria == "Bebida") {
                                    <span class="badge bg-primary">ü•§ @p.Categoria</span>
                                } else {
                                    <span class="badge bg-warning text-dark">üç∞ @p.Categoria</span>
                                }
                            </td>
                            <td class="text-center">
                                @* BOT√ÉO EDITAR *@
                                <button class="btn btn-outline-primary btn-sm me-2" @onclick="() => PrepararEdicao(p)">
                                    <i class="bi bi-pencil"></i> Editar
                                </button>

                                @* BOT√ÉO EXCLUIR *@
                                <button class="btn btn-outline-danger btn-sm" @onclick="() => Excluir(p)">
                                    <i class="bi bi-trash"></i> Excluir
                                </button>
                            </td>
                            
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private Produto novoProduto = new Produto();
    private List<Produto> produtosCadastrados = new();
    
    private bool isEditando = false;

    protected override void OnInitialized()
    {
        CarregarProdutos();
    }

    private void CarregarProdutos()
    {
        produtosCadastrados = DbContext.Produtos.OrderByDescending(p => p.Id).ToList();
    }

    private void Salvar()
    {
        // verifica√ß√£o da categoria
        if (string.IsNullOrWhiteSpace(novoProduto.Nome) || 
            novoProduto.Preco <= 0 || 
            string.IsNullOrWhiteSpace(novoProduto.Categoria))
        {
            return;
        }

        if (isEditando)
        {
            DbContext.Produtos.Update(novoProduto);
        }
        else
        {
            DbContext.Produtos.Add(novoProduto);
        }

        DbContext.SaveChanges();
        LimparFormulario();
        CarregarProdutos();
    }

    private void PrepararEdicao(Produto p)
    {
        novoProduto = p; 
        isEditando = true;
    }

    private void CancelarEdicao()
    {
        novoProduto = new Produto();
        isEditando = false;
        CarregarProdutos(); 
    }

    private void Excluir(Produto produtoParaRemover)
    {
        DbContext.Produtos.Remove(produtoParaRemover);
        DbContext.SaveChanges();
        CarregarProdutos();
    }

    private void LimparFormulario()
{
    novoProduto = new Produto();
    isEditando = false;          
}
}