@page "/vendas"
@using ProjetoRestaurante.Models
@using Microsoft.EntityFrameworkCore
@inject ProjetoRestaurante.Data.AppDbContext DbContext

<h2 class="mb-4">üìã Lan√ßar Novo Pedido</h2>

<div class="row">
    <div class="col-md-7">
        <div class="card shadow-sm">
            <div class="card-header bg-dark text-white">
                <h4 class="mb-0">üç¥ Card√°pio</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    @foreach (var produto in produtosDisponiveis)
                    {
                        <div class="col-md-6 mb-3">
                            <div class="card h-100 border-start border-4 @(produto.Categoria == "Lanche" ? "border-success" : "border-primary")">
                                <div class="card-body d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">@produto.Nome</h6>
                                        <small class="text-muted">@produto.Preco.ToString("C")</small>
                                    </div>
                                    <button class="btn btn-outline-dark btn-sm" @onclick="() => AdicionarAoCarrinho(produto)">
                                        <i class="bi bi-plus-lg"></i> Add
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-5">
        <div class="card shadow border-primary">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">üõí Pedido Atual</h4>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label font-weight-bold">Selecione a Mesa:</label>
                    <div class="d-flex flex-wrap gap-3">
                        @foreach (var m in listaDeMesas)
                        {
                            <div @onclick="() => mesaSelecionadaId = m.Id" 
                                style="cursor:pointer; width: 80px; height: 80px; transition: 0.2s;" 
                                class="card align-items-center justify-content-center fw-bold border-2
                                        @(mesaSelecionadaId == m.Id ? "bg-primary text-white shadow-lg scale-110" : "bg-white text-dark")">
                                
                                <span style="font-size: 0.8rem;" class="@(mesaSelecionadaId == m.Id ? "text-white-50" : "text-muted")">MESA</span>
                                <span style="font-size: 1.5rem;">@m.Numero</span>
                                
                                @if (m.EstaOcupada) 
                                {
                                    <span class="position-absolute top-0 start-50 translate-middle badge rounded-pill bg-danger shadow-sm" 
                                        style="font-size: 0.7rem; z-index: 10;">
                                        OCUPADA
                                    </span>
                                }
                            </div>
                        }
                    </div>
                </div>

                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Qtd</th>
                            <th>Subtotal</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in carrinho)
                        {
                            <tr>
                                <td>@item.Produto?.Nome</td>
                                <td>@item.Quantidade</td>
                                <td>@((item.Quantidade * item.PrecoNoMomento).ToString("C"))</td>
                                <td>
                                    <button class="btn btn-link text-danger p-0" @onclick="() => RemoverDoCarrinho(item)">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>

                <hr />
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Total:</h5>
                    <h3 class="text-success">@totalPedido.ToString("C")</h3>
                </div>

                <button class="btn btn-success btn-lg w-100" 
                        @onclick="FinalizarPedido" 
                        disabled="@(carrinho.Count == 0 || mesaSelecionadaId <= 0)">
                    üî• Enviar para Cozinha
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    private List<Produto> produtosDisponiveis = new();
    private List<ItemPedido> carrinho = new();
    private List<Mesa> listaDeMesas = new();
    
    private int mesaSelecionadaId; 

    private decimal totalPedido => carrinho.Sum(i => i.Quantidade * i.PrecoNoMomento);

    protected override void OnInitialized()
    {
        produtosDisponiveis = DbContext.Produtos.OrderBy(p => p.Nome).ToList();
        listaDeMesas = DbContext.Mesas.OrderBy(m => m.Numero).ToList();
    }

    private void AdicionarAoCarrinho(Produto produto)
    {
        var itemExistente = carrinho.FirstOrDefault(i => i.ProdutoId == produto.Id);
        if (itemExistente != null)
        {
            itemExistente.Quantidade++;
        }
        else
        {
            carrinho.Add(new ItemPedido
            {
                ProdutoId = produto.Id,
                Produto = produto,
                Quantidade = 1,
                PrecoNoMomento = produto.Preco
            });
        }
    }

    private void RemoverDoCarrinho(ItemPedido item) => carrinho.Remove(item);

    private void FinalizarPedido()
    {
        if (mesaSelecionadaId <= 0 || carrinho.Count == 0) return;

        try 
        {
            // Crir o pedido principal
            var novoPedido = new Pedido
            {
                MesaId = mesaSelecionadaId,
                DataHora = DateTime.Now,
                Status = "Pendente",
                ValorTotal = totalPedido,
                Itens = carrinho.Select(i => new ItemPedido {
                    ProdutoId = i.ProdutoId,
                    Quantidade = i.Quantidade,
                    PrecoNoMomento = i.PrecoNoMomento
                }).ToList()
            };

            DbContext.Pedidos.Add(novoPedido);
            
            // Se a Model Mesa tiver o campo 'EstaOcupada', marcar Ocupada
            var mesa = DbContext.Mesas.Find(mesaSelecionadaId);
            if (mesa != null) mesa.EstaOcupada = true;

            DbContext.SaveChanges();

            // Limpeza para o pr√≥ximo
            carrinho.Clear();
            mesaSelecionadaId = 0;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao salvar: {ex.Message}");
        }
    }
}